<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monetizelt</title>

    <!-- Description principale -->
    <meta name="description"
        content="Your market, your rules. Monetizelt lets you sell time-limited digital videos easily. Generate, share, and cash in with full control.">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://g-z.online/" />

    <!-- Open Graph (Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="Monetizelt — Sell and Share Your Digital Videos" />
    <meta property="og:description"
        content="Create your own market, share videos, and get paid instantly with Monetizelt." />
    <meta property="og:url" content="https://g-z.online/" />
    <meta property="og:type" content="website" />
    <meta property="og:image"
        content="https://firebasestorage.googleapis.com/v0/b/monetizelt-b235d.firebasestorage.app/o/1000009017_resized.jpg?alt=media&token=d69084a3-b285-44e4-81a5-f05971314175" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Monetizelt — Sell and Share Your Digital Videos" />
    <meta name="twitter:description"
        content="Create your own market, share videos, and get paid instantly with Monetizelt." />
    <meta name="twitter:image"
        content="https://firebasestorage.googleapis.com/v0/b/monetizelt-b235d.firebasestorage.app/o/1000009017_resized.jpg?alt=media&token=d69084a3-b285-44e4-81a5-f05971314175" />

    <!-- Favicon -->
    <link rel="icon"
        href="https://firebasestorage.googleapis.com/v0/b/monetizelt-b235d.firebasestorage.app/o/1000009017_resized.jpg?alt=media&token=d69084a3-b285-44e4-81a5-f05971314175" />

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --background-color: #f5f5f5;
            --text-color: #333;
            --white: #ffffff;
            --error-color: #ff3333;
            --success-color: #28a745;
            --warning-color: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.3;
            font-size: 13px;
            overflow-x: hidden;
        }

        header {
            background-color: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 3em;
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            border: 1.5px solid var(--primary-color);
            padding: 0px 11px;
            border-radius: 13px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            width: 100%;
            margin: 2px 0;
        }

        .form-container {
            padding: 12px;
            text-align: center;
            background-color: #e9f5ff;
            border: 1px solid var(--primary-color);
            border-radius: 30px;
            margin: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            animation: slideUp 0.8s ease-out;
            position: relative;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .button {
            display: block;
            background-color: #0077BE;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px;
            margin: 12px auto;
            text-decoration: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            text-align: center;
            position: relative;
        }

        .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .form-container input,
        .form-container select,
        .form-container textarea {
            padding: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 12px;
            font-size: 13px;
            -webkit-appearance: none;
            appearance: none;
            max-height: 40px;
        }

        .toggle-button {
            cursor: pointer;
            margin: 12px;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px 12px;
            border-radius: 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .toggle-button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 32px;
            color: var(--primary-dark);
            font-family: 'Billabong', cursive;
            font-weight: normal;
        }

        .forgot-password {
            margin-top: 12px;
            color: var(--primary-color);
            cursor: pointer;
            border: 1px solid var(--primary-color);
            padding: 8px 12px;
            border-radius: 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .forgot-password:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .message {
            margin: 12px auto;
            padding: 10px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 13px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s ease;
            line-height: 1.4;
        }

        .message i {
            margin-right: 8px;
            font-size: 15px;
        }

        .message.error {
            background-color: rgba(255, 51, 51, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(255, 51, 51, 0.3);
        }

        .message.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .message.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .message.info {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .footer-links {
            margin-top: 18px;
            font-size: 11px;
        }

        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0;
            z-index: 1100;
            transition: width 0.3s ease;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 123, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        .password-strength {
            width: 80%;
            max-width: 300px;
            height: 4px;
            background-color: #ddd;
            margin: 4px auto 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        .password-strength-meter {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .password-feedback {
            font-size: 11px;
            margin-bottom: 12px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: var(--primary-color);
            padding: 5px;
            border-radius: 3px;
            filter: invert(1);
        }

        .date-label {
            font-size: 12px;
            color: var(--primary-dark);
            margin-bottom: 5px;
            text-align: left;
            width: 80%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .account-type-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .account-type-btn {
            padding: 8px 16px;
            border: 1px solid var(--primary-color);
            background-color: var(--white);
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .account-type-btn:first-child {
            border-radius: 15px 0 0 15px;
        }

        .account-type-btn:last-child {
            border-radius: 0 15px 15px 0;
        }

        .account-type-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .field-group {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .field-group.active {
            display: block;
        }

        .form-section {
            margin-bottom: 15px;
        }

        .form-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        .loading-dots {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            height: 16px;
        }

        .loading-dots .dot {
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            margin: 0 3px;
            animation: dotPulse 1.4s infinite ease-in-out;
        }

        .loading-dots .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-dots.hidden {
            display: none;
        }

        .input-feedback {
            font-size: 11px;
            color: var(--primary-color);
            margin: -8px auto 8px;
            max-width: 300px;
            text-align: left;
            padding-left: 10%;
        }

        .phone-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            max-width: 300px;
            margin: 0 auto 12px;
        }

        .phone-prefix {
            border: 1px solid var(--primary-color);
            border-right: none;
            border-radius: 15px 0 0 15px;
            padding: 10px;
            background-color: #f0f8ff;
            width: 25%;
            text-align: center;
            font-size: 13px;
            max-height: 40px;
        }

        .phone-number {
            border: 1px solid var(--primary-color);
            border-left: none;
            border-radius: 0 15px 15px 0;
            padding: 10px;
            width: 75%;
            font-size: 13px;
            max-height: 40px;
        }

        .address-suggestions {
            width: 80%;
            max-width: 300px;
            margin: -8px auto 12px;
            text-align: left;
            background-color: white;
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .address-suggestion {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .address-suggestion:hover {
            background-color: #f0f8ff;
        }

        .industry-selector {
            width: 80%;
            max-width: 300px;
            margin: 0 auto 12px;
        }

        .verification-container {
            text-align: center;
            margin: 12px auto;
            max-width: 300px;
        }

        .verification-code {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .verification-code input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 0;
        }

        .verification-timer {
            font-size: 12px;
            margin-top: 8px;
            color: var(--primary-dark);
        }

        .resend-code {
            font-size: 12px;
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 4px;
            display: none;
        }

        /* Reduced text for verification step */
        .verification-hint {
            font-size: 12px;
            color: var(--primary-dark);
            margin-top: 2px;
        }

        .multi-step-container {
            position: relative;
        }

        .step-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .step-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
            margin: 0 4px;
            transition: background-color 0.3s;
        }

        .step-indicator.active {
            background-color: var(--primary-color);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .step-buttons {
            display: flex;
            justify-content: space-between;
            width: 80%;
            max-width: 300px;
            margin: 20px auto 0;
        }

        .prev-step-btn {
            background-color: #f0f0f0;
            color: var(--text-color);
            border: 1px solid #ddd;
        }

        .success-animation {
            text-align: center;
            margin: 20px auto;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            animation: scaleIn 0.5s ease;
        }

        .success-icon i {
            color: white;
            font-size: 40px;
        }

        .redirect-countdown {
            margin-top: 12px;
            font-size: 14px;
            color: var(--primary-dark);
        }

        .reset-password-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .go-back {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
            border: 1px solid var(--primary-color);
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .go-back:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .reset-email-text {
            margin: 20px 0 15px 0;
            font-size: 14px;
            color: var(--text-color);
        }

        /* Splash screen animation styles */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .dots-container {
            width: 80%;
            max-width: 300px;
            height: 60px;
            position: relative;
            margin-bottom: 16px;
        }

        .moving-dot {
            width: 20px;
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        /* UPDATED: dots move to center, touch, and go back */
        #leftDot {
            left: 0;
            animation: moveToCenterLeft 1.6s infinite ease-in-out;
        }

        #rightDot {
            left: calc(100% - 20px);
            animation: moveToCenterRight 1.6s infinite ease-in-out;
        }

        .slogan {
            font-family: 'Billabong', cursive;
            color: var(--primary-dark);
            font-size: 24px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeSlogan 1.6s forwards;
            text-align: center;
            padding: 0 20px;
        }

        /* Styles pour le prompt d'installation */
        #installPrompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--white);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 300px;
            text-align: center;
            animation: slideUpPrompt 0.5s ease;
        }

        @keyframes slideUpPrompt {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .install-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .close-prompt {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        @keyframes dotPulse {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* Dots touching animation */
        @keyframes moveToCenterLeft {
            0% {
                left: 0;
                transform: translateY(-50%) scale(1);
            }

            50% {
                left: calc(50% - 10px);
                transform: translateY(-50%) scale(1.12);
            }

            100% {
                left: 0;
                transform: translateY(-50%) scale(1);
            }
        }

        @keyframes moveToCenterRight {
            0% {
                left: calc(100% - 20px);
                transform: translateY(-50%) scale(1);
            }

            50% {
                left: calc(50% - 10px);
                transform: translateY(-50%) scale(1.12);
            }

            100% {
                left: calc(100% - 20px);
                transform: translateY(-50%) scale(1);
            }
        }

        @keyframes fadeSlogan {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            60% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 1.8em;
            }

            .form-container {
                margin: 12px;
                padding: 16px;
            }

            .button {
                width: 90%;
            }

            .form-container input,
            .form-container select,
            .form-container textarea {
                width: 90%;
                max-height: 40px;
                font-size: 16px;
                /* prevent iOS zoom */
            }

            h2 {
                font-size: 26px;
            }

            .phone-input-container {
                width: 90%;
            }

            .industry-selector {
                width: 90%;
            }

            .splash-screen .slogan {
                font-size: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Splash screen (UPDATED: no profile image, only 2 dots touching) -->
    <div class="splash-screen" id="splashScreen">
        <div class="dots-container" aria-hidden="true">
            <div class="moving-dot" id="leftDot"></div>
            <div class="moving-dot" id="rightDot"></div>
        </div>
        <div class="slogan"></div>
    </div>

    <div class="progress-bar" id="progressBar"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <header>
        <span class="logo" translate="no"><b>Monetizelt</b></span>
    </header>
    <div class="divider"></div>

    <!-- Prompt d'installation (caché par défaut) -->
    <div id="installPrompt">
        <span class="close-prompt" id="closePrompt">&times;</span>
        <p>Installez Monetizelt sur votre appareil pour un accès rapide</p>
        <button class="install-btn" id="installApp">Installer</button>
    </div>

    <div class="form-container" id="loginForm">
        <h2><b>Welcome Back</b></h2>
        <div id="loginMessages"></div>
        <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="email">
        <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
        <button class="button" id="loginUser">
            <div class="loading-dots hidden" id="loginDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            Login
        </button>
        <p class="toggle-button" id="showSignup"><b>No account? Sign up</b></p>
        <p class="forgot-password" id="forgotPassword"><b>Forgot password?</b></p>
        <div class="footer-links">
            <a href="terms.html">Terms of Use</a> |
            <a href="privacy.html">Privacy Policy</a>
        </div>
    </div>

    <div class="form-container reset-password-container" id="resetPasswordForm">
        <h2><b>Reset Password</b></h2>
        <div id="resetPasswordMessages"></div>
        <div class="reset-email-text">Enter your email address</div>
        <input type="email" id="resetEmail" placeholder="Enter your email" required autocomplete="email">
        <button class="button" id="sendResetEmail">
            <div class="loading-dots hidden" id="resetCodeDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            Send Reset Link
        </button>
        <p class="go-back" id="backToLogin"><b>Back to login</b></p>
        <div class="footer-links">
            <a href="terms.html">Terms of Use</a> |
            <a href="privacy.html">Privacy Policy</a>
        </div>
    </div>

    <div class="form-container" id="signupForm" style="display: none;">
        <h2><b>Welcome</b></h2>
        <div id="signupMessages"></div>

        <div class="multi-step-container">
            <div class="step-progress">
                <div class="step-indicator active" data-step="1"></div>
                <div class="step-indicator" data-step="2"></div>
                <div class="step-indicator" data-step="3"></div>
            </div>

            <div class="account-type-selector">
                <button class="account-type-btn active" id="individualBtn">Individual</button>
                <button class="account-type-btn" id="businessBtn">Business</button>
            </div>

            <!-- Step 1: Basic Information -->
            <div class="form-step active" id="step1">
                <div class="form-section">
                    <div class="form-section-title">Account Information</div>
                    <input type="text" id="fullName" placeholder="Full name" required autocomplete="name">
                    <select id="signupCountry" required>
                        <option value="" disabled selected>Select your country</option>
                    </select>
                    <div class="date-label">Select your birth date</div>
                    <input type="date" id="birthdate" required>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required autocomplete="email">
                    <input type="password" id="signupPassword" placeholder="Create a password" required
                        autocomplete="new-password">
                    <div class="password-strength">
                        <div class="password-strength-meter" id="passwordStrengthMeter"></div>
                    </div>
                    <div class="password-feedback" id="passwordFeedback"></div>
                    <input type="password" id="confirmPassword" placeholder="Confirm password" required
                        autocomplete="new-password">
                </div>

                <div class="step-buttons">
                    <button class="button" id="goToStep2">Continue</button>
                </div>
            </div>

            <!-- Step 2: Contact Information -->
            <div class="form-step" id="step2">
                <div class="field-group active" id="individualFields">
                    <div class="form-section">
                        <div class="form-section-title">Personal Information</div>
                        <div class="phone-input-container">
                            <select class="phone-prefix" id="individualPhonePrefix"></select>
                            <input type="tel" class="phone-number" id="individualPhone" placeholder="Phone number"
                                required maxlength="15" inputmode="numeric" autocomplete="tel-national">
                        </div>
                        <div class="input-feedback" id="individualPhoneFeedback"></div>

                        <input type="text" id="individualAddressLine1" placeholder="Address Line 1" required
                            autocomplete="address-line1">
                        <div class="address-suggestions" id="individualAddressSuggestions"></div>
                        <input type="text" id="individualAddressLine2" placeholder="Address Line 2 (optional)"
                            autocomplete="address-line2">
                        <input type="text" id="individualCity" placeholder="City" required
                            autocomplete="address-level2">
                        <input type="text" id="individualPostalCode" placeholder="Postal/ZIP Code" required
                            autocomplete="postal-code">
                        <select id="individualOccupation" required>
                            <option value="" disabled selected>Select your occupation</option>
                            <option value="student">Student</option>
                            <option value="employed">Employed</option>
                            <option value="self-employed">Self-employed</option>
                            <option value="freelancer">Freelancer</option>
                            <option value="unemployed">Unemployed</option>
                            <option value="retired">Retired</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="field-group" id="businessFields">
                    <div class="form-section">
                        <div class="form-section-title">Business Information</div>
                        <input type="text" id="companyName" placeholder="Company name" required
                            autocomplete="organization">
                        <input type="text" id="businessRegistrationNumber" placeholder="Business registration number"
                            required maxlength="20">
                        <select id="businessIndustry" class="industry-selector" required>
                            <option value="" disabled selected>Select your industry</option>
                            <option value="technology">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="services">Professional Services</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="hospitality">E-commerce</option>
                            <option value="transportation">Transportation</option>
                            <option value="construction">Construction</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="energy">Energy</option>
                            <option value="other">Other</option>
                        </select>

                        <select id="companySize" required>
                            <option value="" disabled selected>Company size</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-500">201-500 employees</option>
                            <option value="500+">500+ employees</option>
                        </select>

                        <div class="phone-input-container">
                            <select class="phone-prefix" id="businessPhonePrefix"></select>
                            <input type="tel" class="phone-number" id="businessPhone" placeholder="Business phone"
                                required maxlength="15" inputmode="numeric" autocomplete="tel-national">
                        </div>
                        <div class="input-feedback" id="businessPhoneFeedback"></div>

                        <input type="text" id="businessAddressLine1" placeholder="Business address line 1" required
                            autocomplete="address-line1">
                        <div class="address-suggestions" id="businessAddressSuggestions"></div>
                        <input type="text" id="businessAddressLine2" placeholder="Business address line 2 (optional)"
                            autocomplete="address-line2">
                        <input type="text" id="businessCity" placeholder="City" required autocomplete="address-level2">
                        <input type="text" id="businessPostalCode" placeholder="Postal/ZIP Code" required
                            autocomplete="postal-code">
                        <input type="text" id="businessWebsite" placeholder="Business website (optional)"
                            autocomplete="url">
                    </div>
                </div>

                <div class="step-buttons">
                    <button class="button prev-step-btn" id="backToStep1">Back</button>
                    <button class="button" id="goToStep3">Continue</button>
                </div>
            </div>

            <!-- Step 3: Verification (UPDATED: less text, user just enters code) -->
            <div class="form-step" id="step3">
                <div class="form-section">
                    <div class="form-section-title">Email Verification</div>
                    <div class="verification-container">
                        <div class="verification-hint">Enter the 6-digit code</div>
                        <div class="verification-code">
                            <input type="text" maxlength="1" class="code-digit" id="digit1" inputmode="numeric"
                                autocomplete="one-time-code">
                            <input type="text" maxlength="1" class="code-digit" id="digit2" inputmode="numeric">
                            <input type="text" maxlength="1" class="code-digit" id="digit3" inputmode="numeric">
                            <input type="text" maxlength="1" class="code-digit" id="digit4" inputmode="numeric">
                            <input type="text" maxlength="1" class="code-digit" id="digit5" inputmode="numeric">
                            <input type="text" maxlength="1" class="code-digit" id="digit6" inputmode="numeric">
                        </div>
                        <div class="verification-timer" id="verificationTimer">Resend code in 00:59</div>
                        <div class="resend-code" id="resendCode">Resend code</div>
                    </div>
                </div>

                <div class="step-buttons">
                    <button class="button prev-step-btn" id="backToStep2">Back</button>
                    <button class="button" id="createAccount">
                        <div class="loading-dots hidden" id="signupDots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                        Verify & Create
                    </button>
                </div>
            </div>

            <!-- Success Step -->
            <div class="form-step" id="successStep">
                <div class="success-animation">
                    <div class="success-icon"><i class="fas fa-check"></i></div>
                    <h3>Account Created Successfully!</h3>
                    <p>Welcome to Monetizelt. Your account has been created.</p>
                    <div class="redirect-countdown" id="redirectCountdown">Redirecting in 1 second...</div>
                </div>
            </div>
        </div>

        <p class="toggle-button" id="showLogin"><b>Already have an account? Log in</b></p>
        <div class="footer-links">
            <a href="terms-.html">Terms of Use</a> |
            <a href="privacy-.html">Privacy Policy</a>
        </div>
    </div>

    <!-- =========================================================
       Firebase + App Logic (UPDATED)
       - Firebase CDN switched to 12.8.0 + your new config
       - Email verification is via SendGrid (Cloud Function) not Google
       - Country restriction: only allowed countries can sign up / authenticate
       - Address autocomplete improved (OpenStreetMap Nominatim, no Google)
  ========================================================== -->
    <script type="module">
        /* ---------------------------
           1) Firebase imports (12.8.0)
        ---------------------------- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        /* ---------------------------
           2) Firebase config (YOUR NEW CDN CONFIG)
        ---------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDO9lap1scINWVMArQcB8Py8ZmiqRXJyRQ",
            authDomain: "monetizelt-97bc0.firebaseapp.com",
            databaseURL: "https://monetizelt-97bc0-default-rtdb.firebaseio.com",
            projectId: "monetizelt-97bc0",
            storageBucket: "monetizelt-97bc0.firebasestorage.app",
            messagingSenderId: "586545574919",
            appId: "1:586545574919:web:a92ba568531f12714a66a2",
            measurementId: "G-DSKVXWRZTQ"
        };

        const app = initializeApp(firebaseConfig);

        // Analytics can fail on some environments (file://, blocked cookies, etc.)
        try { getAnalytics(app); } catch (e) { /* ignore */ }

        const auth = getAuth(app);
        const db = getFirestore(app);

        /* ---------------------------
           3) Allowed countries (YOUR LIST)
           Note: "China (China Platform) | C2" -> we treat it as China (CN) for geo/ISO.
        ---------------------------- */
        const ALLOWED_COUNTRIES = [
            { name: "Andorra", code: "AD" },
            { name: "Argentina", code: "AR" },
            { name: "Australia", code: "AU" },
            { name: "Austria", code: "AT" },
            { name: "Bahamas", code: "BS" },
            { name: "Bahrain", code: "BH" },
            { name: "Belgium", code: "BE" },
            { name: "Bermuda", code: "BM" },
            { name: "Botswana", code: "BW" },
            { name: "Brazil", code: "BR" },
            { name: "Bulgaria", code: "BG" },
            { name: "Canada", code: "CA" },
            { name: "Cayman Islands", code: "KY" },
            { name: "Chile", code: "CL" },
            { name: "China", code: "CN" }, // normalized from C2 to CN
            { name: "Colombia", code: "CO" },
            { name: "Costa Rica", code: "CR" },
            { name: "Croatia", code: "HR" },
            { name: "Cyprus", code: "CY" },
            { name: "Czech Republic", code: "CZ" },
            { name: "Denmark", code: "DK" },
            { name: "Dominican Republic", code: "DO" },
            { name: "Ecuador", code: "EC" },
            { name: "El Salvador", code: "SV" },
            { name: "Estonia", code: "EE" },
            { name: "Faroe Islands", code: "FO" },
            { name: "Finland", code: "FI" },
            { name: "France", code: "FR" },
            { name: "Georgia", code: "GE" },
            { name: "Germany", code: "DE" },
            { name: "Gibraltar", code: "GI" },
            { name: "Greece", code: "GR" },
            { name: "Greenland", code: "GL" },
            { name: "Guatemala", code: "GT" },
            { name: "Honduras", code: "HN" },
            { name: "Hong Kong", code: "HK" }, // normalized label
            { name: "Hungary", code: "HU" },
            { name: "Iceland", code: "IS" },
            { name: "India", code: "IN" },
            { name: "Indonesia", code: "ID" },
            { name: "Ireland", code: "IE" },
            { name: "Israel", code: "IL" },
            { name: "Italy", code: "IT" },
            { name: "Jamaica", code: "JM" },
            { name: "Japan", code: "JP" },
            { name: "Jordan", code: "JO" },
            { name: "Kazakhstan", code: "KZ" },
            { name: "Kenya", code: "KE" },
            { name: "Kuwait", code: "KW" },
            { name: "Latvia", code: "LV" },
            { name: "Lesotho", code: "LS" },
            { name: "Liechtenstein", code: "LI" },
            { name: "Lithuania", code: "LT" },
            { name: "Luxembourg", code: "LU" },
            { name: "Malaysia", code: "MY" },
            { name: "Malta", code: "MT" },
            { name: "Mauritius", code: "MU" },
            { name: "Mexico", code: "MX" },
            { name: "Moldova", code: "MD" },
            { name: "Monaco", code: "MC" },
            { name: "Morocco", code: "MA" },
            { name: "Mozambique", code: "MZ" },
            { name: "Netherlands", code: "NL" },
            { name: "New Zealand", code: "NZ" },
            { name: "Nicaragua", code: "NI" },
            { name: "Norway", code: "NO" },
            { name: "Oman", code: "OM" },
            { name: "Panama", code: "PA" },
            { name: "Peru", code: "PE" },
            { name: "Philippines", code: "PH" },
            { name: "Poland", code: "PL" },
            { name: "Portugal", code: "PT" },
            { name: "Qatar", code: "QA" },
            { name: "Réunion", code: "RE" },
            { name: "Romania", code: "RO" },
            { name: "San Marino", code: "SM" },
            { name: "Saudi Arabia", code: "SA" },
            { name: "Senegal", code: "SN" },
            { name: "Serbia", code: "RS" },
            { name: "Singapore", code: "SG" },
            { name: "Slovakia", code: "SK" },
            { name: "Slovenia", code: "SI" },
            { name: "South Africa", code: "ZA" },
            { name: "Spain", code: "ES" },
            { name: "Sweden", code: "SE" },
            { name: "Switzerland", code: "CH" },
            { name: "Turkey", code: "TR" },
            { name: "United Arab Emirates", code: "AE" },
            { name: "United Kingdom", code: "GB" },
            { name: "United States", code: "US" },
            { name: "Uruguay", code: "UY" },
            { name: "Venezuela", code: "VE" },
            { name: "Vietnam", code: "VN" }
        ];

        const ALLOWED_CODES = new Set(ALLOWED_COUNTRIES.map(c => c.code.toUpperCase()));
        const ALLOWED_NAME_TO_CODE = new Map(ALLOWED_COUNTRIES.map(c => [c.name, c.code]));

        /* ---------------------------
           4) DOM refs
        ---------------------------- */
        const splashScreen = document.getElementById('splashScreen');
        let deferredPrompt;

        const installPrompt = document.getElementById('installPrompt');
        const closePromptBtn = document.getElementById('closePrompt');
        const installAppBtn = document.getElementById('installApp');

        const progressBar = document.getElementById('progressBar');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const loginMessages = document.getElementById('loginMessages');
        const signupMessages = document.getElementById('signupMessages');
        const resetPasswordMessages = document.getElementById('resetPasswordMessages');

        const loginDots = document.getElementById('loginDots');
        const signupDots = document.getElementById('signupDots');
        const resetCodeDots = document.getElementById('resetCodeDots');

        const countrySelect = document.getElementById('signupCountry');

        const individualBtn = document.getElementById('individualBtn');
        const businessBtn = document.getElementById('businessBtn');
        const individualFields = document.getElementById('individualFields');
        const businessFields = document.getElementById('businessFields');

        const individualPhonePrefix = document.getElementById('individualPhonePrefix');
        const businessPhonePrefix = document.getElementById('businessPhonePrefix');
        const individualPhoneFeedback = document.getElementById('individualPhoneFeedback');
        const businessPhoneFeedback = document.getElementById('businessPhoneFeedback');

        const individualAddressSuggestions = document.getElementById('individualAddressSuggestions');
        const businessAddressSuggestions = document.getElementById('businessAddressSuggestions');

        const individualPhone = document.getElementById('individualPhone');
        const businessPhone = document.getElementById('businessPhone');
        const businessRegistrationNumber = document.getElementById('businessRegistrationNumber');

        const loginForm = document.getElementById('loginForm');
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const signupForm = document.getElementById('signupForm');

        const steps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.step-indicator');
        const goToStep2Btn = document.getElementById('goToStep2');
        const goToStep3Btn = document.getElementById('goToStep3');
        const backToStep1Btn = document.getElementById('backToStep1');
        const backToStep2Btn = document.getElementById('backToStep2');
        const createAccountBtn = document.getElementById('createAccount');
        const redirectCountdown = document.getElementById('redirectCountdown');

        const verificationTimer = document.getElementById('verificationTimer');
        const resendCode = document.getElementById('resendCode');
        const codeDigits = document.querySelectorAll('#step3 .code-digit');

        /* ---------------------------
           5) State
        ---------------------------- */
        let currentAccountType = 'individual';
        let redirectionActive = false;
        let currentStep = 1;

        let countriesLoaded = false;
        let countryPhoneCodes = {}; // key: countryName => "+33"
        let phoneMaxLengths = {};
        let businessRegNumberFormats = {};

        let verificationTimerInterval;
        let verificationSecondsLeft = 59;
        let verificationCode = "";

        let addressAutocompleteTimeout;
        let geoCountryCode = null;
        let geoAllowed = true; // default allow until checked (or you can default false)

        /* ---------------------------
           6) UI helpers
        ---------------------------- */
        function showMessage(container, message, type = 'error') {
            const iconClass = type === 'error' ? 'fa-circle-exclamation' :
                type === 'success' ? 'fa-circle-check' :
                    type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-info';

            container.innerHTML = `
        <div class="message ${type}">
          <i class="fas ${iconClass}"></i>
          ${message}
        </div>
      `;
        }

        function simulateProgress(start, end, duration) {
            const startTime = Date.now();
            progressBar.style.width = start + '%';

            function updateProgress() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min((elapsed / duration) * (end - start) + start, end);
                progressBar.style.width = progress + '%';

                if (progress < end) requestAnimationFrame(updateProgress);
                else if (end === 100) setTimeout(() => { progressBar.style.width = '0%'; }, 300);
            }
            requestAnimationFrame(updateProgress);
        }

        function toggleLoader(show) {
            if (show) loadingOverlay.classList.add('active');
            else loadingOverlay.classList.remove('active');
        }

        function setBtnLoading(button, dots, isLoading) {
            button.disabled = isLoading;
            dots.classList.toggle('hidden', !isLoading);
        }

        function handleSplashScreen() {
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                setTimeout(() => { splashScreen.style.display = 'none'; }, 500);
            }, 1500);
        }

        /* ---------------------------
           7) PWA install handling (unchanged)
        ---------------------------- */
        function handlePWAInstallation() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log("App can be installed.");
            });

            closePromptBtn.addEventListener('click', () => {
                installPrompt.style.display = 'none';
            });

            installAppBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                installPrompt.style.display = 'none';
                deferredPrompt = null;
            });

            window.addEventListener('appinstalled', () => {
                installPrompt.style.display = 'none';
                deferredPrompt = null;
            });
        }

        /* ---------------------------
           8) Country restriction (Geo IP)
           Requirement: users not from allowed countries must not sign up / authenticate.
           Message must be in English.
        ---------------------------- */
        async function detectUserCountry() {
            try {
                // ipwho.is is free and returns country_code.
                const res = await fetch("https://ipwho.is/?fields=success,country_code,country");
                const data = await res.json();
                if (data && data.success && data.country_code) {
                    geoCountryCode = String(data.country_code).toUpperCase();
                    geoAllowed = ALLOWED_CODES.has(geoCountryCode);
                    return;
                }
            } catch (e) {
                // ignore
            }
            // If detection fails, we don't hard-block (so you can still test).
            geoAllowed = true;
        }

        function enforceCountryAvailabilityUI() {
            const loginBtn = document.getElementById("loginUser");
            const showSignupBtn = document.getElementById("showSignup");
            const createAccountBtnEl = document.getElementById("createAccount");
            const goStep2 = document.getElementById("goToStep2");
            const goStep3 = document.getElementById("goToStep3");

            if (!geoAllowed) {
                const msg = "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.";
                showMessage(loginMessages, msg, "warning");

                // Disable auth actions
                loginBtn.disabled = true;
                showSignupBtn.style.pointerEvents = "none";
                showSignupBtn.style.opacity = "0.6";

                // If user is already on signup, block actions too
                goStep2.disabled = true;
                goStep3.disabled = true;
                createAccountBtnEl.disabled = true;

                // Also show message on signup if visible later
            } else {
                loginBtn.disabled = false;
                showSignupBtn.style.pointerEvents = "auto";
                showSignupBtn.style.opacity = "1";
                goStep2.disabled = false;
                goStep3.disabled = false;
                createAccountBtnEl.disabled = false;
            }
        }

        function assertAllowedOrBlock(container) {
            if (!geoAllowed) {
                const msg = "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.";
                showMessage(container, msg, "warning");
                return false;
            }
            return true;
        }

        /* ---------------------------
           9) Account type switching (unchanged)
        ---------------------------- */
        function switchAccountType(type) {
            if (type === currentAccountType) return;

            const oldFields = currentAccountType === 'individual' ? individualFields : businessFields;
            const newFields = type === 'individual' ? individualFields : businessFields;

            oldFields.style.opacity = '1';
            const fadeOut = oldFields.animate([{ opacity: 1 }, { opacity: 0 }], {
                duration: 300, easing: 'ease-out', fill: 'forwards'
            });

            fadeOut.onfinish = () => {
                oldFields.classList.remove('active');
                newFields.classList.add('active');

                newFields.style.opacity = '0';
                newFields.animate([{ opacity: 0 }, { opacity: 1 }], {
                    duration: 300, easing: 'ease-in', fill: 'forwards'
                });

                currentAccountType = type;
            };
        }

        individualBtn.addEventListener('click', () => {
            individualBtn.classList.add('active');
            businessBtn.classList.remove('active');
            switchAccountType('individual');
        });
        businessBtn.addEventListener('click', () => {
            businessBtn.classList.add('active');
            individualBtn.classList.remove('active');
            switchAccountType('business');
        });

        /* ---------------------------
           10) Form switching
        ---------------------------- */
        function switchForm(showFormId) {
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            resetPasswordForm.style.display = 'none';

            document.getElementById(showFormId).style.display = 'block';

            loginMessages.innerHTML = '';
            signupMessages.innerHTML = '';
            resetPasswordMessages.innerHTML = '';

            // If user is blocked by country, show message on the visible form too.
            if (!geoAllowed) {
                const msg = "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.";
                const target = showFormId === "signupForm" ? signupMessages : (showFormId === "resetPasswordForm" ? resetPasswordMessages : loginMessages);
                showMessage(target, msg, "warning");
            }
        }

        /* ---------------------------
           11) Multi-step navigation
        ---------------------------- */
        function goToStep(step) {
            steps.forEach(s => s.classList.remove('active'));
            stepIndicators.forEach(ind => {
                if (parseInt(ind.dataset.step) <= step) ind.classList.add('active');
                else ind.classList.remove('active');
            });

            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            signupMessages.innerHTML = '';
        }

        function showSuccessStep() {
            steps.forEach(s => s.classList.remove('active'));
            document.getElementById('successStep').classList.add('active');

            let secondsLeft = 1;
            const countdownInterval = setInterval(() => {
                secondsLeft--;
                redirectCountdown.textContent = `Redirecting in ${secondsLeft} second${secondsLeft !== 1 ? 's' : ''}...`;
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    toggleLoader(true);
                    window.location.href = "dashboard.html";
                }
            }, 1000);
        }

        /* ---------------------------
           12) Password strength
        ---------------------------- */
        function evaluatePasswordStrength(password, meterElementId, feedbackElementId) {
            const meter = document.getElementById(meterElementId);
            const feedback = document.getElementById(feedbackElementId);

            if (!password) {
                meter.style.width = '0%';
                feedback.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length > 5) strength += 20;
            if (password.length > 8) strength += 10;
            if (/[a-z]/.test(password)) strength += 10;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 20;

            let color, message;
            if (strength < 30) { color = '#ff4d4d'; message = 'Very weak password'; }
            else if (strength < 50) { color = '#ffaa00'; message = 'Weak password'; }
            else if (strength < 70) { color = '#ffdd00'; message = 'Medium password'; }
            else { color = '#4CAF50'; message = strength < 90 ? 'Strong password' : 'Very strong password'; }

            meter.style.width = strength + '%';
            meter.style.backgroundColor = color;
            feedback.textContent = message;
            feedback.style.color = color;
        }

        /* ---------------------------
           13) Verification code (SendGrid)
           UPDATED: Now using the Cloud Function to actually send emails.
        ---------------------------- */
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendVerificationEmail(email, code) {
            try {
                // Use the SendGrid cloud function endpoint
                const endpoint = 'https://us-central1-monetizelt-97bc0.cloudfunctions.net/sendVerificationCode';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });

                const data = await response.json();
                return data.success === true;
            } catch (error) {
                console.error("Error sending verification email:", error);
                return false;
            }
        }

        function startVerificationTimer() {
            verificationSecondsLeft = 59;
            resendCode.style.display = 'none';
            verificationTimer.style.display = 'block';

            clearInterval(verificationTimerInterval);
            verificationTimerInterval = setInterval(() => {
                verificationSecondsLeft--;
                verificationTimer.textContent = `Resend code in 00:${verificationSecondsLeft < 10 ? '0' + verificationSecondsLeft : verificationSecondsLeft}`;

                if (verificationSecondsLeft <= 0) {
                    clearInterval(verificationTimerInterval);
                    verificationTimer.style.display = 'none';
                    resendCode.style.display = 'block';
                }
            }, 1000);
        }

        async function sendEmailVerificationCode(email) {
            verificationCode = generateVerificationCode();
            codeDigits.forEach(d => d.value = '');

            startVerificationTimer();

            showMessage(signupMessages, "Sending code...", "info");
            const ok = await sendVerificationEmail(email, verificationCode);
            if (ok) showMessage(signupMessages, "Code sent.", "success");
            else showMessage(signupMessages, "Failed to send code. Please try again.", "error");
            return ok;
        }

        function getVerificationCode(codeInputs) {
            return Array.from(codeInputs).map(d => d.value).join('');
        }

        // Improved code input UX: digits only, auto-next, backspace, paste full code
        function setupVerificationCodeFields(codeInputs) {
            // Paste support on first box
            codeInputs[0].addEventListener('paste', (e) => {
                const text = (e.clipboardData || window.clipboardData).getData('text') || '';
                const digits = text.replace(/\D/g, '').slice(0, 6).split('');
                if (digits.length) {
                    e.preventDefault();
                    digits.forEach((ch, i) => { if (codeInputs[i]) codeInputs[i].value = ch; });
                    const nextIndex = Math.min(digits.length, codeInputs.length - 1);
                    codeInputs[nextIndex].focus();
                    if (digits.length === 6) document.getElementById("createAccount").click();
                }
            });

            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function () {
                    this.value = this.value.replace(/\D/g, '').slice(0, 1);

                    if (this.value && index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    }

                    // Auto-submit when all 6 digits are filled
                    const code = getVerificationCode(codeInputs);
                    if (code.length === 6 && !code.includes('')) {
                        // if all fields filled
                        document.getElementById("createAccount").click();
                    }
                });

                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });

                input.addEventListener('keypress', function (e) {
                    if (!/\d/.test(e.key)) e.preventDefault();
                });
            });
        }

        resendCode.addEventListener('click', () => {
            const email = document.getElementById("signupEmail").value.trim();
            sendEmailVerificationCode(email);
        });

        /* ---------------------------
           14) Countries + phone prefixes (allowed only)
           - Populates dropdown with your allowed list
           - Fetches phone codes from restcountries (alpha by codes)
        ---------------------------- */
        async function loadAllowedCountriesAndPhoneCodes() {
            if (countriesLoaded) return;

            // Fill country select (allowed only)
            countrySelect.innerHTML = '<option value="" disabled selected>Select your country</option>';
            ALLOWED_COUNTRIES
                .slice()
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(({ name }) => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    countrySelect.appendChild(opt);
                });

            // Fetch phone data for allowed ISO codes
            const codes = ALLOWED_COUNTRIES.map(c => c.code).join(',');
            try {
                const resp = await fetch(`https://restcountries.com/v3.1/alpha?codes=${encodeURIComponent(codes)}&fields=name,idd,cca2`);
                if (!resp.ok) throw new Error("restcountries failed");
                const list = await resp.json();

                // Build map countryName -> phoneRoot(+suffix)
                countryPhoneCodes = {};
                const allPrefixes = new Map(); // prefix -> display string

                list.forEach(c => {
                    const name = c?.name?.common;
                    const idd = c?.idd;
                    const cca2 = c?.cca2;

                    if (!name) return;
                    if (!ALLOWED_CODES.has(String(cca2 || '').toUpperCase())) return;

                    if (idd && idd.root) {
                        const root = idd.root;
                        const suffix = (idd.suffixes && idd.suffixes.length) ? idd.suffixes[0] : '';
                        const full = root + suffix;
                        countryPhoneCodes[name] = full;

                        // Collect prefixes for dropdowns
                        allPrefixes.set(full, `${full} (${name})`);
                    }
                });

                populatePhonePrefixes(Array.from(allPrefixes.entries()).sort((a, b) => a[1].localeCompare(b[1])));
                countriesLoaded = true;
            } catch (e) {
                console.error("Phone/country fetch failed, using fallback.", e);

                // Minimal fallback (still allowed-only)
                countryPhoneCodes = {
                    "United States": "+1",
                    "Canada": "+1",
                    "United Kingdom": "+44",
                    "France": "+33",
                    "Germany": "+49",
                    "Australia": "+61",
                    "Japan": "+81",
                    "China": "+86"
                };

                const fallbackPrefixes = [
                    ["+1", "+1 (United States/Canada)"],
                    ["+44", "+44 (United Kingdom)"],
                    ["+33", "+33 (France)"],
                    ["+49", "+49 (Germany)"],
                    ["+61", "+61 (Australia)"],
                    ["+81", "+81 (Japan)"],
                    ["+86", "+86 (China)"]
                ];
                populatePhonePrefixes(fallbackPrefixes);
                countriesLoaded = true;
            }
        }

        function populatePhonePrefixes(prefixEntries) {
            individualPhonePrefix.innerHTML = '';
            businessPhonePrefix.innerHTML = '';

            prefixEntries.forEach(([value, label]) => {
                const o1 = document.createElement('option');
                o1.value = value;
                o1.textContent = label;
                individualPhonePrefix.appendChild(o1);

                const o2 = document.createElement('option');
                o2.value = value;
                o2.textContent = label;
                businessPhonePrefix.appendChild(o2);
            });

            // default try +1 else first
            individualPhonePrefix.value = prefixEntries.some(([v]) => v === "+1") ? "+1" : prefixEntries[0]?.[0] || "";
            businessPhonePrefix.value = individualPhonePrefix.value;

            setPhoneMaxLengths();
            setBusinessRegNumberFormats();

            individualPhone.setAttribute('maxlength', phoneMaxLengths[individualPhonePrefix.value] || phoneMaxLengths.default);
            businessPhone.setAttribute('maxlength', phoneMaxLengths[businessPhonePrefix.value] || phoneMaxLengths.default);
        }

        /* ---------------------------
           15) Phone + business registration validation (kept)
        ---------------------------- */
        function setPhoneMaxLengths() {
            phoneMaxLengths = {
                '+1': 10, '+44': 11, '+33': 9, '+49': 11, '+61': 9, '+86': 11, '+81': 10, '+34': 9,
                '+39': 10, '+55': 11, '+91': 10, '+52': 10, '+7': 10, '+65': 8, '+971': 9,
                default: 15
            };
        }

        function setBusinessRegNumberFormats() {
            businessRegNumberFormats = {
                'United States': [/^[0-9]{2}-[0-9]{7}$|^[0-9]{9}$/, 10],
                'United Kingdom': [/^[0-9]{8}$/, 8],
                'France': [/^[0-9]{9}$/, 9],
                'Germany': [/^[A-Z]{2}[0-9]{6}$|^[0-9]{9}$/, 9],
                'Australia': [/^[0-9]{9}$/, 9],
                'Canada': [/^[0-9]{9}$|^[0-9]{15}$/, 15],
                default: [/^[A-Za-z0-9\-\s]{1,20}$/, 20]
            };
        }

        function validatePhoneNumber(phoneNumber, countryCode) {
            const cleanedNumber = phoneNumber.replace(/[\s\-()]/g, '');

            if (!/^\d+$/.test(cleanedNumber)) return { valid: false, message: "Phone number should contain only digits" };

            const numberLengths = {
                '+1': { min: 10, max: 10 },
                '+44': { min: 10, max: 11 },
                '+33': { min: 9, max: 9 },
                '+49': { min: 10, max: 11 },
                '+61': { min: 9, max: 9 }
            };

            if (numberLengths[countryCode]) {
                const { min, max } = numberLengths[countryCode];
                if (cleanedNumber.length < min || cleanedNumber.length > max) {
                    return { valid: false, message: `Phone number should be between ${min} and ${max} digits for this country code` };
                }
            } else if (cleanedNumber.length < 7 || cleanedNumber.length > 15) {
                return { valid: false, message: "Phone number length is invalid" };
            }

            return { valid: true, message: "Valid phone number" };
        }

        function validateBusinessRegistrationNumber(number, country) {
            const [regex, maxLength] = businessRegNumberFormats[country] || businessRegNumberFormats.default;
            const cleanedNumber = number.trim();

            if (cleanedNumber.length > maxLength) {
                return { valid: false, message: `Business registration number should be maximum ${maxLength} characters for ${country}` };
            }
            if (!regex.test(cleanedNumber)) {
                let message;
                if (country === 'United States') message = "US EIN should be in format XX-XXXXXXX or XXXXXXXXX";
                else if (country === 'United Kingdom') message = "UK Company number should be 8 digits";
                else if (country === 'France') message = "SIREN should be 9 digits";
                else message = "Invalid business registration number format";
                return { valid: false, message };
            }
            return { valid: true, message: "Valid business registration number" };
        }

        function formatBusinessRegistrationNumber(input, country) {
            let value = input.value.replace(/\s+/g, '');

            if (country === 'United States') {
                if (value.length > 2 && !value.includes('-')) value = value.substring(0, 2) + '-' + value.substring(2);
            } else if (country === 'Canada') {
                if (value.length > 9 && !value.includes(' ')) value = value.substring(0, 9) + ' ' + value.substring(9);
            }

            const [, maxLength] = businessRegNumberFormats[country] || businessRegNumberFormats.default;
            if (value.length > maxLength) value = value.substring(0, maxLength);
            input.value = value;
        }

        function handlePhoneInput(inputElement, feedbackElement, prefixElement) {
            const countryCode = prefixElement.value;
            const maxLength = phoneMaxLengths[countryCode] || phoneMaxLengths.default;

            const cleanedNumber = inputElement.value.replace(/\D/g, '');
            inputElement.value = cleanedNumber.substring(0, maxLength);

            const result = validatePhoneNumber(inputElement.value, countryCode);
            if (result.valid) {
                feedbackElement.textContent = "✓ Valid phone number";
                feedbackElement.style.color = "var(--success-color)";
                inputElement.style.borderColor = "var(--success-color)";
            } else {
                feedbackElement.textContent = result.message;
                feedbackElement.style.color = "var(--error-color)";
                inputElement.style.borderColor = "var(--error-color)";
            }
        }

        function setupPhoneListeners() {
            individualPhonePrefix.addEventListener('change', function () {
                individualPhone.value = '';
                individualPhoneFeedback.textContent = '';
                individualPhone.style.borderColor = "var(--primary-color)";
                individualPhone.setAttribute('maxlength', phoneMaxLengths[this.value] || phoneMaxLengths.default);
            });

            businessPhonePrefix.addEventListener('change', function () {
                businessPhone.value = '';
                businessPhoneFeedback.textContent = '';
                businessPhone.style.borderColor = "var(--primary-color)";
                businessPhone.setAttribute('maxlength', phoneMaxLengths[this.value] || phoneMaxLengths.default);
            });

            individualPhone.addEventListener('input', function () { handlePhoneInput(this, individualPhoneFeedback, individualPhonePrefix); });
            businessPhone.addEventListener('input', function () { handlePhoneInput(this, businessPhoneFeedback, businessPhonePrefix); });

            individualPhone.addEventListener('keypress', e => { if (!/\d/.test(e.key)) e.preventDefault(); });
            businessPhone.addEventListener('keypress', e => { if (!/\d/.test(e.key)) e.preventDefault(); });

            businessRegistrationNumber.addEventListener('input', () => {
                const country = document.getElementById('signupCountry').value;
                formatBusinessRegistrationNumber(businessRegistrationNumber, country);
            });

            document.getElementById('signupCountry').addEventListener('change', function () {
                const country = this.value;
                const [, regMaxLength] = businessRegNumberFormats[country] || businessRegNumberFormats.default;
                businessRegistrationNumber.setAttribute('maxlength', regMaxLength);
                if (businessRegistrationNumber.value) formatBusinessRegistrationNumber(businessRegistrationNumber, country);
            });
        }

        /* ---------------------------
           16) Address autocomplete (IMPROVED, no Google)
           Uses OpenStreetMap Nominatim.
           Also tries to fill city + postal code when selecting suggestion.
        ---------------------------- */
        function countryNameToApproxIso2(name) {
            // We stored ISO2 in ALLOWED_COUNTRIES, so use that map.
            const code = ALLOWED_NAME_TO_CODE.get(name);
            return code ? code.toLowerCase() : null;
        }

        async function fetchAddressSuggestions(query, countryName) {
            const iso2 = countryNameToApproxIso2(countryName); // e.g. "fr"
            const url = new URL("https://nominatim.openstreetmap.org/search");
            url.searchParams.set("format", "json");
            url.searchParams.set("addressdetails", "1");
            url.searchParams.set("limit", "6");
            url.searchParams.set("q", query);
            if (iso2) url.searchParams.set("countrycodes", iso2);

            const res = await fetch(url.toString(), {
                headers: { "Accept": "application/json" }
            });
            if (!res.ok) return [];
            return await res.json();
        }

        function renderSuggestions(list, suggestionsElement, onPick) {
            suggestionsElement.innerHTML = '';
            if (!list.length) {
                suggestionsElement.style.display = 'none';
                return;
            }

            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'address-suggestion';
                div.textContent = item.display_name;
                div.addEventListener('click', () => onPick(item));
                suggestionsElement.appendChild(div);
            });

            suggestionsElement.style.display = 'block';
        }

        function initAddressAutocomplete(inputElement, suggestionsElement, cityEl, postalEl) {
            inputElement.addEventListener('input', function () {
                clearTimeout(addressAutocompleteTimeout);

                const q = this.value.trim();
                if (q.length < 3) {
                    suggestionsElement.style.display = 'none';
                    return;
                }

                addressAutocompleteTimeout = setTimeout(async () => {
                    const country = document.getElementById("signupCountry").value;
                    try {
                        const list = await fetchAddressSuggestions(q, country);
                        renderSuggestions(list, suggestionsElement, (picked) => {
                            inputElement.value = picked.display_name;

                            // Try fill city + postal
                            const addr = picked.address || {};
                            const city = addr.city || addr.town || addr.village || addr.county || "";
                            const post = addr.postcode || "";

                            if (cityEl && city) cityEl.value = city;
                            if (postalEl && post) postalEl.value = post;

                            suggestionsElement.style.display = 'none';
                        });
                    } catch (e) {
                        suggestionsElement.style.display = 'none';
                    }
                }, 250);
            });

            document.addEventListener('click', function (e) {
                if (e.target !== inputElement && !suggestionsElement.contains(e.target)) {
                    suggestionsElement.style.display = 'none';
                }
            });
        }

        /* ---------------------------
           17) UserID uniqueness (fixed)
           Use a dedicated collection "userIds" to avoid polluting users collection.
           Keeps backward compatibility by also checking old doc if it exists.
        ---------------------------- */
        function generateUserId() {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const numbers = "0123456789";
            let result = '';
            for (let i = 0; i < 3; i++) result += letters.charAt(Math.floor(Math.random() * letters.length));
            for (let i = 0; i < 3; i++) result += numbers.charAt(Math.floor(Math.random() * numbers.length));
            return result.split('').sort(() => 0.5 - Math.random()).join('');
        }

        async function isUserIdUnique(userId) {
            try {
                const newLoc = await getDoc(doc(db, "userIds", userId));
                if (newLoc.exists()) return false;

                // backward-compat check (old location used previously)
                const oldLoc = await getDoc(doc(db, "users", `userId_${userId}`));
                if (oldLoc.exists()) return false;

                return true;
            } catch (e) {
                console.error("Error checking userId uniqueness:", e);
                return false;
            }
        }

        async function generateUniqueUserId() {
            let attempts = 0;
            while (attempts < 10) {
                const id = generateUserId();
                if (await isUserIdUnique(id)) return id;
                attempts++;
            }
            throw new Error("Unable to generate unique userId");
        }

        /* ---------------------------
           18) Auth state redirect
        ---------------------------- */
        async function checkUserProfileAndRedirect(user) {
            try {
                redirectionActive = true;
                toggleLoader(true);

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    window.location.href = "dashboard.html";
                } else {
                    redirectionActive = false;
                    toggleLoader(false);
                }
            } catch (e) {
                console.error("Error checking user profile:", e);
                redirectionActive = false;
                toggleLoader(false);
            }
        }

        /* ---------------------------
           19) Step validations + flows
           (Added: allowed-country check)
        ---------------------------- */
        goToStep2Btn.addEventListener('click', () => {
            if (!assertAllowedOrBlock(signupMessages)) return;

            const fullName = document.getElementById("fullName").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const country = document.getElementById("signupCountry").value;
            const birthdate = new Date(document.getElementById("birthdate").value);
            const today = new Date();

            if (!fullName) return showMessage(signupMessages, "Please enter your full name", "error");
            if (!country) return showMessage(signupMessages, "Please select your country", "error");

            // Ensure selected country is allowed (even if someone hacks DOM)
            const selectedCode = ALLOWED_NAME_TO_CODE.get(country);
            if (!selectedCode) {
                return showMessage(signupMessages, "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.", "warning");
            }

            if (!birthdate || isNaN(birthdate.getTime())) return showMessage(signupMessages, "Please enter a valid birth date", "error");

            const age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            const adjustedAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate()) ? age - 1 : age;
            if (adjustedAge < 18) return showMessage(signupMessages, "You must be at least 18 years old", "error");

            if (!email) return showMessage(signupMessages, "Please enter your email address", "error");
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return showMessage(signupMessages, "Please enter a valid email address", "error");

            if (!password) return showMessage(signupMessages, "Please enter a password", "error");
            if (password.length < 6) return showMessage(signupMessages, "Password must be at least 6 characters", "error");
            if (password !== confirmPassword) return showMessage(signupMessages, "Passwords don't match", "error");

            goToStep(2);

            // Update phone prefix based on selected country (if found)
            const phoneCode = countryPhoneCodes[country];
            if (phoneCode) {
                individualPhonePrefix.value = phoneCode;
                businessPhonePrefix.value = phoneCode;
                const maxLength = phoneMaxLengths[phoneCode] || phoneMaxLengths.default;
                individualPhone.setAttribute('maxlength', maxLength);
                businessPhone.setAttribute('maxlength', maxLength);
            }

            const [, regMaxLength] = businessRegNumberFormats[country] || businessRegNumberFormats.default;
            businessRegistrationNumber.setAttribute('maxlength', regMaxLength);
        });

        backToStep1Btn.addEventListener('click', () => goToStep(1));

        goToStep3Btn.addEventListener('click', async () => {
            if (!assertAllowedOrBlock(signupMessages)) return;

            // Validate step2 depending account type
            if (currentAccountType === 'individual') {
                const phone = document.getElementById("individualPhone").value.trim();
                const addressLine1 = document.getElementById("individualAddressLine1").value.trim();
                const city = document.getElementById("individualCity").value.trim();
                const postalCode = document.getElementById("individualPostalCode").value.trim();
                const occupation = document.getElementById("individualOccupation").value;

                if (!phone) return showMessage(signupMessages, "Please enter your phone number", "error");
                const phoneValidation = validatePhoneNumber(phone, individualPhonePrefix.value);
                if (!phoneValidation.valid) return showMessage(signupMessages, phoneValidation.message, "error");

                if (!addressLine1) return showMessage(signupMessages, "Please enter your address", "error");
                if (!city) return showMessage(signupMessages, "Please enter your city", "error");
                if (!postalCode) return showMessage(signupMessages, "Please enter your postal/ZIP code", "error");
                if (!occupation) return showMessage(signupMessages, "Please select your occupation", "error");
            } else {
                const country = document.getElementById("signupCountry").value;
                const companyName = document.getElementById("companyName").value.trim();
                const registrationNumber = document.getElementById("businessRegistrationNumber").value.trim();
                const industry = document.getElementById("businessIndustry").value;
                const companySize = document.getElementById("companySize").value;
                const businessPhoneVal = document.getElementById("businessPhone").value.trim();
                const addressLine1 = document.getElementById("businessAddressLine1").value.trim();
                const city = document.getElementById("businessCity").value.trim();
                const postalCode = document.getElementById("businessPostalCode").value.trim();

                if (!companyName) return showMessage(signupMessages, "Please enter your company name", "error");
                if (!registrationNumber) return showMessage(signupMessages, "Please enter business registration number", "error");

                const regValidation = validateBusinessRegistrationNumber(registrationNumber, country);
                if (!regValidation.valid) return showMessage(signupMessages, regValidation.message, "error");

                if (!industry) return showMessage(signupMessages, "Please select your industry", "error");
                if (!companySize) return showMessage(signupMessages, "Please select your company size", "error");

                if (!businessPhoneVal) return showMessage(signupMessages, "Please enter business phone", "error");
                const phoneValidation = validatePhoneNumber(businessPhoneVal, businessPhonePrefix.value);
                if (!phoneValidation.valid) return showMessage(signupMessages, phoneValidation.message, "error");

                if (!addressLine1) return showMessage(signupMessages, "Please enter business address", "error");
                if (!city) return showMessage(signupMessages, "Please enter your city", "error");
                if (!postalCode) return showMessage(signupMessages, "Please enter your postal/ZIP code", "error");
            }

            goToStep(3);

            // Send code via SendGrid
            const email = document.getElementById("signupEmail").value.trim();
            await sendEmailVerificationCode(email);

            // Focus first digit
            codeDigits[0].focus();
        });

        backToStep2Btn.addEventListener('click', () => goToStep(2));

        /* ---------------------------
           20) Create account (verification required)
           (Added: allowed-country check + minimal step text already)
        ---------------------------- */
        document.getElementById("createAccount").addEventListener("click", async function () {
            if (!assertAllowedOrBlock(signupMessages)) return;

            setBtnLoading(this, signupDots, true);
            simulateProgress(0, 40, 300);

            const enteredCode = getVerificationCode(codeDigits);
            if (enteredCode.length !== 6) {
                showMessage(signupMessages, "Please enter the 6-digit code.", "error");
                setBtnLoading(this, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            if (enteredCode !== verificationCode) {
                showMessage(signupMessages, "Invalid code. Please try again.", "error");
                setBtnLoading(this, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }

            const fullName = document.getElementById("fullName").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            const country = document.getElementById("signupCountry").value;
            const birthdate = new Date(document.getElementById("birthdate").value);

            // Hard check allowed selection
            const selectedCode = ALLOWED_NAME_TO_CODE.get(country);
            if (!selectedCode) {
                showMessage(signupMessages, "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.", "warning");
                setBtnLoading(this, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }

            let userData = {
                fullName,
                email,
                country,
                countryCode: selectedCode,
                birthdate: birthdate.toISOString().split('T')[0],
                accountType: currentAccountType,
                createdAt: serverTimestamp(),
                lastLogin: serverTimestamp(),
                products: [],
                linksCount: 0,
                viewsCount: 0,
                ordersCount: 0,
                shippedCount: 0,
                revenueCount: 0,
                onboardingComplete: false,
                transactions: []
            };

            if (currentAccountType === 'individual') {
                const phonePrefix = document.getElementById("individualPhonePrefix").value;
                const phone = document.getElementById("individualPhone").value.trim();
                const addressLine1 = document.getElementById("individualAddressLine1").value.trim();
                const addressLine2 = document.getElementById("individualAddressLine2").value.trim();
                const city = document.getElementById("individualCity").value.trim();
                const postalCode = document.getElementById("individualPostalCode").value.trim();
                const occupation = document.getElementById("individualOccupation").value;

                userData = {
                    ...userData,
                    phonePrefix,
                    phone,
                    address: {
                        line1: addressLine1,
                        line2: addressLine2 || null,
                        city,
                        postalCode,
                        country
                    },
                    occupation
                };
            } else {
                const companyName = document.getElementById("companyName").value.trim();
                const registrationNumber = document.getElementById("businessRegistrationNumber").value.trim();
                const industry = document.getElementById("businessIndustry").value;
                const companySize = document.getElementById("companySize").value;
                const phonePrefix = document.getElementById("businessPhonePrefix").value;
                const phone = document.getElementById("businessPhone").value.trim();
                const addressLine1 = document.getElementById("businessAddressLine1").value.trim();
                const addressLine2 = document.getElementById("businessAddressLine2").value.trim();
                const city = document.getElementById("businessCity").value.trim();
                const postalCode = document.getElementById("businessPostalCode").value.trim();
                const website = document.getElementById("businessWebsite").value.trim();

                userData = {
                    ...userData,
                    companyName,
                    registrationNumber,
                    industry,
                    companySize,
                    phonePrefix,
                    phone,
                    address: {
                        line1: addressLine1,
                        line2: addressLine2 || null,
                        city,
                        postalCode,
                        country
                    },
                    website: website || null
                };
            }

            simulateProgress(40, 60, 300);

            try {
                showMessage(signupMessages, "Creating your account...", "info");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                simulateProgress(60, 80, 400);
                showMessage(signupMessages, "Generating your unique ID...", "info");

                const userId = await generateUniqueUserId();

                userData = { ...userData, uid: user.uid, userId };

                await setDoc(doc(db, "users", user.uid), userData);

                // Reserve the userId
                await setDoc(doc(db, "userIds", userId), { uid: user.uid, createdAt: serverTimestamp() });

                // Backward compatibility (optional)
                await setDoc(doc(db, "users", `userId_${userId}`), { uid: user.uid, createdAt: serverTimestamp() });

                simulateProgress(80, 100, 300);
                redirectionActive = true;
                showSuccessStep();
            } catch (error) {
                console.error("Create account error:", error);

                let errorMessage = "Error creating account";
                if (error.code === 'auth/invalid-email') errorMessage = "Invalid email address format";
                else if (error.code === 'auth/weak-password') errorMessage = "Password should be at least 6 characters";
                else if (error.code === 'auth/email-already-in-use') errorMessage = "This email is already associated with an account";
                else if (error.code === 'auth/network-request-failed') errorMessage = "Network error. Please check your internet connection";
                else errorMessage = "Error: " + (error.message || "Please try again.");

                showMessage(signupMessages, errorMessage, "error");
                setBtnLoading(this, signupDots, false);
                simulateProgress(60, 100, 100);
            }
        });

        /* ---------------------------
           21) Login (Added: allowed-country check)
        ---------------------------- */
        document.getElementById("loginUser").addEventListener("click", async function () {
            if (!assertAllowedOrBlock(loginMessages)) return;

            setBtnLoading(this, loginDots, true);
            simulateProgress(0, 50, 500);

            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;

            if (!email) {
                showMessage(loginMessages, "Please enter your email", "error");
                setBtnLoading(this, loginDots, false);
                simulateProgress(50, 100, 100);
                return;
            }
            if (!password) {
                showMessage(loginMessages, "Please enter your password", "error");
                setBtnLoading(this, loginDots, false);
                simulateProgress(50, 100, 100);
                return;
            }

            try {
                showMessage(loginMessages, "Logging in...", "info");
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                try {
                    await setDoc(doc(db, "users", user.uid), { lastLogin: serverTimestamp() }, { merge: true });
                } catch (e) {
                    console.error("Error updating last login:", e);
                }

                simulateProgress(50, 100, 300);
                showMessage(loginMessages, "Login successful! Redirecting...", "success");

                redirectionActive = true;
                setTimeout(() => {
                    toggleLoader(true);
                    window.location.href = "dashboard.html";
                }, 1000);
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Login error. Please try again later";
                if (error.code === 'auth/user-not-found') errorMessage = "No account found with this email address";
                else if (error.code === 'auth/wrong-password') errorMessage = "Incorrect password. Please try again";
                else if (error.code === 'auth/invalid-email') errorMessage = "Invalid email format";
                else if (error.code === 'auth/too-many-requests') errorMessage = "Too many failed attempts. Please try again later";
                else if (error.code === 'auth/network-request-failed') errorMessage = "Network error. Please check your internet connection";

                showMessage(loginMessages, errorMessage, "error");
                setBtnLoading(this, loginDots, false);
                simulateProgress(50, 100, 100);
            }
        });

        /* ---------------------------
           22) Reset password (kept, also blocked if country not allowed)
        ---------------------------- */
        document.getElementById('sendResetEmail').addEventListener('click', async function () {
            if (!assertAllowedOrBlock(resetPasswordMessages)) return;

            const email = document.getElementById('resetEmail').value.trim();
            if (!email) return showMessage(resetPasswordMessages, "Please enter your email address", "error");

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return showMessage(resetPasswordMessages, "Please enter a valid email address", "error");

            setBtnLoading(this, resetCodeDots, true);
            simulateProgress(0, 50, 500);

            try {
                await sendPasswordResetEmail(auth, email);
                simulateProgress(50, 100, 300);
                showMessage(resetPasswordMessages, "Password reset email sent. Please check your inbox.", "success");

                setTimeout(() => {
                    switchForm('loginForm');
                    showMessage(loginMessages, "Password reset email sent.", "success");
                    document.getElementById('loginEmail').value = email;
                }, 2500);
            } catch (error) {
                console.error("Reset password error:", error);
                simulateProgress(50, 100, 100);
                if (error.code === 'auth/user-not-found') showMessage(resetPasswordMessages, "No account found with this email address", "error");
                else showMessage(resetPasswordMessages, "An error occurred. Please try again later.", "error");
            } finally {
                setBtnLoading(this, resetCodeDots, false);
            }
        });

        /* ---------------------------
           23) Nav buttons
        ---------------------------- */
        document.getElementById("forgotPassword").addEventListener("click", () => switchForm('resetPasswordForm'));
        document.getElementById("backToLogin").addEventListener("click", () => switchForm('loginForm'));

        document.getElementById("showSignup").addEventListener("click", () => {
            switchForm('signupForm');
            document.getElementById("fullName").focus();
            if (!geoAllowed) {
                showMessage(signupMessages, "Sorry, Monetizelt is not available in your country yet. We apologize for the inconvenience.", "warning");
            }
        });

        document.getElementById("showLogin").addEventListener("click", () => {
            switchForm('loginForm');
            document.getElementById("loginEmail").focus();
        });

        /* ---------------------------
           24) Key press navigation (kept)
        ---------------------------- */
        document.getElementById("loginEmail").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("loginPassword").focus(); });
        document.getElementById("loginPassword").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("loginUser").click(); });

        document.getElementById("fullName").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("signupCountry").focus(); });
        document.getElementById("signupCountry").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("birthdate").focus(); });
        document.getElementById("birthdate").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("signupEmail").focus(); });
        document.getElementById("signupEmail").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("signupPassword").focus(); });
        document.getElementById("signupPassword").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("confirmPassword").focus(); });
        document.getElementById("confirmPassword").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("goToStep2").click(); });

        document.getElementById("resetEmail").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("sendResetEmail").click(); });

        /* ---------------------------
           25) Init
        ---------------------------- */
        async function init() {
            handleSplashScreen();
            handlePWAInstallation();

            // Birthdate max = today
            const today = new Date();
            document.getElementById('birthdate').setAttribute('max', today.toISOString().split('T')[0]);

            // Detect geo country and enforce availability
            await detectUserCountry();
            enforceCountryAvailabilityUI();

            // Load allowed countries + phone codes
            await loadAllowedCountriesAndPhoneCodes();

            // Setup phone validation
            setupPhoneListeners();

            // Address autocomplete (improved)
            initAddressAutocomplete(
                document.getElementById('individualAddressLine1'),
                individualAddressSuggestions,
                document.getElementById('individualCity'),
                document.getElementById('individualPostalCode')
            );
            initAddressAutocomplete(
                document.getElementById('businessAddressLine1'),
                businessAddressSuggestions,
                document.getElementById('businessCity'),
                document.getElementById('businessPostalCode')
            );

            // Password strength
            document.getElementById('signupPassword').addEventListener('input', function () {
                evaluatePasswordStrength(this.value, 'passwordStrengthMeter', 'passwordFeedback');
            });

            // Verification inputs
            setupVerificationCodeFields(codeDigits);

            // Auth state redirect
            onAuthStateChanged(auth, (user) => {
                if (user && !redirectionActive) checkUserProfileAndRedirect(user);
            });
        }

        init();

        /* ---------------------------
           26) Service worker registration (kept)
        ---------------------------- */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').then(
                    reg => console.log('ServiceWorker registration successful with scope: ', reg.scope),
                    err => console.log('ServiceWorker registration failed: ', err)
                );
            });
        }
    </script>
</body>

</html>
